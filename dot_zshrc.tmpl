# compinit キャッシュ化（24時間に1回のみ再構築）
autoload -Uz compinit
if [[ -n ~/.zcompdump(#qN.mh+24) ]]; then
  compinit
else
  compinit -C
fi

bindkey -d # キーバインドをリセット
bindkey -e # emacsモードで使う

# シェルオプション
setopt auto_pushd
setopt pushd_ignore_dups
setopt auto_cd
setopt hist_ignore_dups
setopt share_history
setopt inc_append_history
setopt extended_history     # 実行時間も保存
setopt hist_reduce_blanks   # 余分なスペースを削除してヒストリに保存

set nrformats=hex,bin

# zinit (クローン処理は run_once_before_ に移動済み)
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"
source "${ZINIT_HOME}/zinit.zsh"

autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

# zinit annexes
zinit light-mode for \
    zdharma-continuum/zinit-annex-as-monitor \
    zdharma-continuum/zinit-annex-bin-gem-node \
    zdharma-continuum/zinit-annex-patch-dl \
    zdharma-continuum/zinit-annex-rust

# zinit プラグイン (turbo mode で遅延ロード)
zinit wait lucid light-mode for \
  atinit"zicompinit; zicdreplay" \
      zdharma-continuum/fast-syntax-highlighting \
  atload"_zsh_autosuggest_start" \
      zsh-users/zsh-autosuggestions

zinit wait lucid for \
    agkozak/zsh-z

# エイリアス
alias killQL='killall -9 -v QuickLookUIService'
alias mkcd='(){mkdir $1;cd $1}'

# neovimのエイリアス設定
if command -v nvim &> /dev/null; then
  alias vi="nvim"
  alias vim="nvim"
  alias view="nvim -R"
fi

# ディレクトリ移動時にls
chpwd() {
    if [[ $(pwd) != $HOME ]]; then;
        ls -la
    fi
}

# mise activate (インタラクティブ用)
command -v mise &> /dev/null && eval "$(mise activate zsh)"

# ツール連携（eval系）
command -v direnv &> /dev/null && eval "$(direnv hook zsh)"
command -v starship &> /dev/null && eval "$(starship init zsh)"
command -v fzf &> /dev/null && source <(fzf --zsh)
command -v zoxide &> /dev/null && eval "$(zoxide init zsh)"

# task completion (遅延ロード)
if command -v task &> /dev/null; then
  eval "$(task --completion zsh)"
fi

# mise completion (遅延ロード)
if command -v mise &> /dev/null; then
  eval "$(mise completion zsh)"
fi

# fbr - checkout git branch (including remote branches), sorted by most recent commit, limit 30 last branches
fbr() {
  local branches branch
  branches=$(git for-each-ref --count=30 --sort=-committerdate refs/heads/ --format="%(refname:short)") &&
  branch=$(echo "$branches" |
           fzf-tmux -d $(( 2 + $(wc -l <<< "$branches") )) +m) &&
  git checkout $(echo "$branch" | sed "s/.* //" | sed "s#remotes/[^/]*/##")
}

# プロセスをkill
fkill() {
  local pid
  pid=$(ps -ef | sed 1d | fzf -m | awk '{print $2}')

  if [ "x$pid" != "x" ]
  then
    echo $pid | xargs kill -${1:-9}
  fi
}

# macOS固有の設定
{{- if eq .chezmoi.os "darwin" }}
{{- if stat (joinPath .chezmoi.homeDir ".rd/bin") }}
# Rancher Desktopの設定（存在する場合のみ）
### MANAGED BY RANCHER DESKTOP START (DO NOT EDIT)
export PATH="{{ .chezmoi.homeDir }}/.rd/bin:$PATH"
### MANAGED BY RANCHER DESKTOP END (DO NOT EDIT)
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir ".antigravity/antigravity/bin") }}
### MANAGED BY ANTIGRAVITY START (DO NOT EDIT)
# Added by Antigravity
export PATH="{{ .chezmoi.homeDir }}/.antigravity/antigravity/bin:$PATH"
### MANAGED BY ANTIGRAVITY END (DO NOT EDIT)
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir ".codeium/windsurf/bin") }}
### MANAGED BY WINDSURF START (DO NOT EDIT)
# Added by Windsurf
export PATH="{{ .chezmoi.homeDir }}/.codeium/windsurf/bin:$PATH"
### MANAGED BY WINDSURF END (DO NOT EDIT)
{{- end }}
# NOTE: file descriptor limitを増やす
ulimit -n 65536

export PATH="/opt/homebrew/opt/tcl-tk/bin:$PATH"
{{- end }}

# MySQL clientの設定（Homebrewとmysql-clientが存在する場合のみ）
{{- if lookPath "brew" }}
{{-   $brewPrefix := output "brew" "--prefix" | trim }}
{{-   if stat (joinPath $brewPrefix "opt/mysql-client") }}
export PATH="{{ $brewPrefix }}/opt/mysql-client/bin:$PATH"
export LDFLAGS="-L{{ $brewPrefix }}/opt/mysql-client/lib"
export CPPFLAGS="-I{{ $brewPrefix }}/opt/mysql-client/include"
{{-   end }}
{{- end }}

# ローカル設定の読み込み（最後に実行）
# これらのファイルはGit管理されません
if [ -f ~/.zshrc.local ]; then
    source ~/.zshrc.local
fi

if [ -d ~/.zsh/local ]; then
    for file in ~/.zsh/local/*.zsh(N); do
        source "$file"
    done
fi

# カスタム関数の読み込み
if [ -d ~/.zsh/functions ]; then
    for file in ~/.zsh/functions/*.zsh(N); do
        source "$file"
    done
fi
