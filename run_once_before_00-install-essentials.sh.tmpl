#!/bin/bash
set -e

# XDG Base Directory
export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"

echo "=== chezmoi 初回セットアップ ==="

# sudo 権限を事前に要求（パスワード入力）
echo "セットアップには管理者権限が必要です。"
sudo -v

# sudo 認証を維持（バックグラウンドで更新）
while true; do sudo -n true; sleep 50; kill -0 "$$" || exit; done 2>/dev/null &

# 0. zsh インストール（Linux の場合）
{{- if eq .chezmoi.os "linux" }}
if ! command -v zsh &> /dev/null; then
  echo "Installing zsh..."
  {{- if or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian") }}
  sudo apt update && sudo apt install -y zsh
  {{- else if or (eq .chezmoi.osRelease.id "fedora") (eq .chezmoi.osRelease.id "rhel") (eq .chezmoi.osRelease.id "centos") }}
  sudo dnf install -y zsh
  {{- else if eq .chezmoi.osRelease.id "arch" }}
  sudo pacman -S --noconfirm zsh
  {{- end }}
fi

# デフォルトシェルを zsh に変更
if [ "$SHELL" != "$(which zsh)" ]; then
  echo "Changing default shell to zsh..."
  chsh -s "$(which zsh)"
fi
{{- end }}

# 1. Homebrew インストール
{{- if eq .chezmoi.os "darwin" }}
{{-   if eq .chezmoi.arch "arm64" }}
BREW_PATH="/opt/homebrew/bin/brew"
{{-   else }}
BREW_PATH="/usr/local/bin/brew"
{{-   end }}
{{- else if eq .chezmoi.os "linux" }}
BREW_PATH="/home/linuxbrew/.linuxbrew/bin/brew"
{{- end }}

if [ ! -x "$BREW_PATH" ]; then
  echo "Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Homebrew を PATH に追加（この時点では zshenv 未展開）
if [ -x "$BREW_PATH" ]; then
  eval "$($BREW_PATH shellenv)"
fi

# 2. aqua インストール
if ! command -v aqua &> /dev/null; then
  echo "Installing aqua..."
  brew install aquaproj/aqua/aqua
fi

# aqua を PATH に追加
export PATH="$XDG_DATA_HOME/aquaproj-aqua/bin:$PATH"

# 3. zinit インストール
ZINIT_HOME="$XDG_DATA_HOME/zinit/zinit.git"
if [ ! -d "$ZINIT_HOME/.git" ]; then
  echo "Installing zinit..."
  mkdir -p "$(dirname "$ZINIT_HOME")"
  git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi

# 4. cursor-agent インストール（macOS のみ）
{{- if eq .chezmoi.os "darwin" }}
if ! command -v cursor-agent &> /dev/null; then
  echo "Installing cursor-agent..."
  curl https://cursor.com/install -fsS | bash
fi
{{- end }}

echo "=== 初回セットアップ完了 ==="
echo ""
echo "新しい設定を反映するには、以下を実行してください:"
echo "  exec zsh -l"
echo "または新しいターミナルを開いてください。"
